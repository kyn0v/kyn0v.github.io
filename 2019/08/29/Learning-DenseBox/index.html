<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>DenseBoxä»£ç è§£æ | Kyno&#39;s BlogğŸ±â€ğŸ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="è·ç¦»ä¸Šæ¬¡æ›´æ–°åšå®¢åˆå¾ˆä¹…äº†ã€‚å‰æ®µæ—¶é—´ç…§ç€githubä¸Šçš„ä»£ç å¤ç°äº†ä¸‹DenseBoxï¼Œæœ‰æ‰€æ”¶è·è®°å½•ä¸€ä¸‹ã€‚   DenseBoxä»£ç æ•´ä½“ç»“æ„ densebox&#x2F;   __init__.pyï¼šå°†æ–‡ä»¶å¤¹å˜ä¸ºä¸€ä¸ªPythonæ¨¡å—   DenseBox.pyï¼šç½‘ç»œç»“æ„ç›¸å…³ä»£ç    DenseBoxDataset.pyï¼šæ•°æ®é›†åŠ è½½ç›¸å…³ä»£ç      train.pyï¼šæ„å»ºç½‘ç»œ-&gt;è¯»å–æ•°æ®-&gt;è®­ç»ƒç½‘ç»œ">
<meta property="og:type" content="article">
<meta property="og:title" content="DenseBoxä»£ç è§£æ">
<meta property="og:url" content="http://example.com/2019/08/29/Learning-DenseBox/index.html">
<meta property="og:site_name" content="Kyno&#39;s BlogğŸ±â€ğŸ">
<meta property="og:description" content="è·ç¦»ä¸Šæ¬¡æ›´æ–°åšå®¢åˆå¾ˆä¹…äº†ã€‚å‰æ®µæ—¶é—´ç…§ç€githubä¸Šçš„ä»£ç å¤ç°äº†ä¸‹DenseBoxï¼Œæœ‰æ‰€æ”¶è·è®°å½•ä¸€ä¸‹ã€‚   DenseBoxä»£ç æ•´ä½“ç»“æ„ densebox&#x2F;   __init__.pyï¼šå°†æ–‡ä»¶å¤¹å˜ä¸ºä¸€ä¸ªPythonæ¨¡å—   DenseBox.pyï¼šç½‘ç»œç»“æ„ç›¸å…³ä»£ç    DenseBoxDataset.pyï¼šæ•°æ®é›†åŠ è½½ç›¸å…³ä»£ç      train.pyï¼šæ„å»ºç½‘ç»œ-&gt;è¯»å–æ•°æ®-&gt;è®­ç»ƒç½‘ç»œ">
<meta property="og:locale">
<meta property="article:published_time" content="2019-08-29T13:08:39.000Z">
<meta property="article:modified_time" content="2021-02-06T15:04:56.760Z">
<meta property="article:author" content="Kyno Yang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Kyno's BlogğŸ±â€ğŸ" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Kyno&#39;s BlogğŸ±â€ğŸ</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">æ£‰çººå‚åŸä½æ°‘ï¼Œä¸œçººå¹¼å„¿å›­æ¯•ä¸šç”Ÿ</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Learning-DenseBox" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/29/Learning-DenseBox/" class="article-date">
  <time class="dt-published" datetime="2019-08-29T13:08:39.000Z" itemprop="datePublished">2019-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      DenseBoxä»£ç è§£æ
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>è·ç¦»ä¸Šæ¬¡æ›´æ–°åšå®¢åˆå¾ˆä¹…äº†ã€‚å‰æ®µæ—¶é—´ç…§ç€githubä¸Šçš„ä»£ç å¤ç°äº†ä¸‹DenseBoxï¼Œæœ‰æ‰€æ”¶è·è®°å½•ä¸€ä¸‹ã€‚  </p>
<h1 id="DenseBoxä»£ç æ•´ä½“ç»“æ„"><a href="#DenseBoxä»£ç æ•´ä½“ç»“æ„" class="headerlink" title="DenseBoxä»£ç æ•´ä½“ç»“æ„"></a>DenseBoxä»£ç æ•´ä½“ç»“æ„</h1><ul>
<li>densebox/  <ul>
<li>__init__.pyï¼šå°†æ–‡ä»¶å¤¹å˜ä¸ºä¸€ä¸ªPythonæ¨¡å—  </li>
<li>DenseBox.pyï¼šç½‘ç»œç»“æ„ç›¸å…³ä»£ç   </li>
<li>DenseBoxDataset.pyï¼šæ•°æ®é›†åŠ è½½ç›¸å…³ä»£ç   </li>
</ul>
</li>
<li>train.pyï¼šæ„å»ºç½‘ç»œ-&gt;è¯»å–æ•°æ®-&gt;è®­ç»ƒç½‘ç»œ  </li>
<li>test.pyï¼šæ„å»ºç½‘ç»œ-&gt;è¯»å–æ•°æ®-&gt;æµ‹è¯•æ•°æ®  </li>
</ul>
<h2 id="densebox-init-pyè§£æ"><a href="#densebox-init-pyè§£æ" class="headerlink" title="densebox/__init__.pyè§£æ"></a>densebox/__init__.pyè§£æ</h2><p>denseboxæ–‡ä»¶å¤¹ä¸‹ï¼Œ__init__æ–‡ä»¶çš„å†…å®¹ä¸º:  </p>
<pre><code>from .DenseBoxDataset import DenseBoxDataset  
from .DenseBox import DenseBox  
__all__ = [&#39;DenseBoxDataset&#39;, &#39;DenseBox&#39;]  
</code></pre>
<p>è¿™æ®µä»£ç çš„ä½œç”¨æ˜¯ä½¿å¾—denseboxæ–‡ä»¶å¤¹å˜ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œæ¢ä¸€ä¸ªè§’åº¦æ¥è¯´ï¼Œå°±æ˜¯æå‡äº†åŒ…çš„å¯¼å…¥æƒé™ï¼Œåªè¦åœ¨__all__ä¸­å£°æ˜çš„å†…å®¹ï¼Œå¯ä»¥ç›´æ¥åœ¨ä¸Šä¸€å±‚ç›®å½•ä¸­å¯¼å…¥ï¼Œå¦‚train.pyæ–‡ä»¶çš„å¼€å¤´ï¼š  </p>
<pre><code>from densebox import DenseBoxDataset  
from densebox import DenseBox  
</code></pre>
<p>å¦‚æœä½¿ç”¨<code>from densebox import *</code>ï¼Œåˆ™ä¼šæŠŠæ³¨å†Œåœ¨__all__åˆ—è¡¨ä¸­çš„å­æ¨¡å—å’Œå­åŒ…å¯¼å…¥åˆ°å½“å‰ä½œç”¨åŸŸä¸­æ¥ã€‚  </p>
<h2 id="densebox-DenseBox-pyè§£æ"><a href="#densebox-DenseBox-pyè§£æ" class="headerlink" title="densebox/DenseBox.pyè§£æ"></a>densebox/DenseBox.pyè§£æ</h2><p>DenseBox.pyç”¨äºæ„å»ºç½‘ç»œç»“æ„ï¼Œé¦–å…ˆå®šä¹‰æ¨¡å‹ç»“æ„<code>class DenseBox(torch.nn.Module)</code>ï¼Œç„¶åå®ç°<code>__init__</code>å‡½æ•°å’Œ<code>forward</code>å‡½æ•°ã€‚  </p>
<ul>
<li><p>__init__(self, vgg19)  </p>
<p>  __init__å‡½æ•°ç”¨äºåˆå§‹åŒ–ç½‘ç»œç»“æ„ï¼Œå®ƒç»§æ‰¿çˆ¶ç±»çš„__init__å‡½æ•°ï¼š<code>super(DenseBox, self).__init__()</code>  </p>
<p>  å‚æ•°vgg19ç”¨äºåˆå§‹åŒ–DenseBoxåˆå§‹ç»“æ„ï¼Œå› ä¸ºDenseBoxçš„ä¸»å¹²ç½‘ç»œæ˜¯åŸºäºvgg19çš„ï¼š<code>feats = vgg19.features._modules</code>  </p>
<p>  ç„¶åä¾æ¬¡æ·»åŠ å·ç§¯ã€æ± åŒ–ç­‰ç½‘ç»œç»“æ„ï¼š  </p>
<pre><code># ----------------- Conv1  
self.conv1_1_1 = copy.deepcopy(feats[&#39;0&#39;])  # (0)  
self.conv1_1_2 = copy.deepcopy(feats[&#39;1&#39;])  # (1)  
self.conv1_1 = nn.Sequential(  
    self.conv1_1_1,  
    self.conv1_1_2  
)  # conv_layer1  

#...(ä¸­é—´ç»“æ„çœç•¥)...  

# ----------------- Conv4  
self.conv4_1_1 = copy.deepcopy(feats[&#39;19&#39;])  # (19)  
self.conv4_1_2 = copy.deepcopy(feats[&#39;20&#39;])  # (20)  
self.conv4_1 = nn.Sequential(  
    self.conv4_1_1,  
    self.conv4_1_2  
)  # conv_layer9  

self.conv4_2_1 = copy.deepcopy(feats[&#39;21&#39;])  # (21)  
self.conv4_2_2 = copy.deepcopy(feats[&#39;22&#39;])  # (22)  
self.conv4_2 = nn.Sequential(  
    self.conv4_2_1,  
    self.conv4_2_2  
)  # conv_layer10  

self.conv4_3_1 = copy.deepcopy(feats[&#39;23&#39;])  # (23)  
self.conv4_3_2 = copy.deepcopy(feats[&#39;24&#39;])  # (24)  
self.conv4_3 = nn.Sequential(  
    self.conv4_3_1,  
    self.conv4_3_2  
)  # conv_layer11  

self.conv4_4_1 = copy.deepcopy(feats[&#39;25&#39;])  # (25)  
self.conv4_4_2 = copy.deepcopy(feats[&#39;26&#39;])  # (26)  
self.conv4_4 = nn.Sequential(  
    self.conv4_4_1,  
    self.conv4_4_2  
)  
</code></pre>
<p>  score outputç»“æ„ï¼Œè¾“å‡ºç½®ä¿¡åˆ†ï¼š  </p>
<pre><code>self.conv5_1_det = nn.Conv2d(in_channels=768,  
                                 out_channels=512,  
                                 kernel_size=(1, 1))  
self.conv5_2_det = nn.Conv2d(in_channels=512,  
                                out_channels=1,  
                                kernel_size=(1, 1))  
torch.nn.init.xavier_normal_(self.conv5_1_det.weight.data)  
torch.nn.init.xavier_normal_(self.conv5_2_det.weight.data)  

self.output_score = nn.Sequential(  
    self.conv5_1_det,  
    nn.Dropout(),  
    self.conv5_2_det  
)  
</code></pre>
<p>  loc outputç»“æ„ï¼Œè¾“å‡ºbboxåç§»é‡ï¼š  </p>
<pre><code>self.conv5_1_loc = nn.Conv2d(in_channels=768,  
                                 out_channels=512,  
                                 kernel_size=(1, 1))  
self.conv5_2_loc = nn.Conv2d(in_channels=512,  
                                out_channels=4,  
                                kernel_size=(1, 1))  
torch.nn.init.xavier_normal_(self.conv5_1_loc.weight.data)  
torch.nn.init.xavier_normal_(self.conv5_2_loc.weight.data)  

self.output_loc = nn.Sequential(  
    self.conv5_1_loc,  
    nn.Dropout(),  
    self.conv5_2_loc  
)  
</code></pre>
</li>
<li><p>forward(self, X)  </p>
<p>  forwardå‡½æ•°ç”¨äºå‰å‘ä¼ æ’­ï¼Œè¾“å…¥ä¸ºå›¾åƒXï¼Œä¾æ¬¡é€šè¿‡ç½‘ç»œå„ä¸ªç»“æ„ï¼š  </p>
<pre><code>X = self.conv1_1(X)  
X = self.conv1_2(X)  
X = self.pool1(X)  
#...(çœç•¥ä¸­é—´è¿‡ç¨‹)...  
conv4_4_X = self.conv4_4(X)  

# ä¸Šé‡‡æ ·åä¸ä½å±‚ç‰¹å¾è¿›è¡Œç‰¹å¾èåˆ  
conv4_4_X_us = nn.Upsample(size=(conv3_4_X.size(2),  
                                     conv3_4_X.size(3)),  
                            mode=&#39;bilinear&#39;,  
                            align_corners=True)(conv4_4_X)  
fusion = torch.cat((conv4_4_X_us, conv3_4_X), dim=1)  

#è¿”å›ç»“æœ  
scores = self.output_score(fusion)  
locs = self.output_loc(fusion)  
return scores, locs  
</code></pre>
</li>
</ul>
<h2 id="densebox-DenseBoxDataset-pyè§£æ"><a href="#densebox-DenseBoxDataset-pyè§£æ" class="headerlink" title="densebox/DenseBoxDataset.pyè§£æ"></a>densebox/DenseBoxDataset.pyè§£æ</h2><p>DenseBoxDataset.pyç”¨äºå¤„ç†è¯»å…¥æ•°æ®ï¼Œé¦–å…ˆå®šä¹‰è‡ªå®šä¹‰æ•°æ®é›†<code>class DenseBoxDataset(Dataset)</code>ï¼Œç„¶åä¸»è¦å®ç°<code>__init__</code>å‡½æ•°ã€<code>__getitem__</code>å‡½æ•°å’Œ<code>__len__</code>å‡½æ•°ã€‚  </p>
<ul>
<li><p>__init__(self, root, ann_file = â€˜train.jsonâ€™, size=(240, 240), test_mode=False)  </p>
<p>  __init__å‡½æ•°ç”¨äºåˆå§‹åŒ–è¾“å…¥æ•°æ®ï¼ˆæ‰€æœ‰å›¾ç‰‡çš„annotationï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢åˆ°è¦æ±‚çš„å½¢å¼è¯»å…¥å†…å­˜ï¼š  </p>
<ol>
<li>é¦–å…ˆåŠ è½½æ•°æ®é›†æ‰€æœ‰å›¾ç‰‡ä¿¡æ¯ï¼ˆload_annotationså‡½æ•°ï¼‰ï¼›  </li>
<li>ç„¶åä»è¯»å–çš„æ•°æ®ä¸­è§£æå‡ºæ¯å¼ å›¾ç‰‡çš„annotationä¿¡æ¯ï¼ˆget_ann_infoå‡½æ•°å’Œ_parse_ann_infoå‡½æ•°ï¼‰ï¼Œä»annotationä¸­è§£æå‡ºbboxä¿¡æ¯å’Œlabelä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦ï¼Œè¿˜å¯ä»¥bboxè½¬æ¢åˆ°æŒ‡å®šçš„åæ ‡ç©ºé—´ï¼‰ï¼Œå¹¶ä½¿ç”¨listæœ‰åºä¿å­˜ã€‚è¿™æ ·æ¯å¼ å›¾ç‰‡çš„GTå°±åŠ è½½åˆ°å†…å­˜ä¸­äº†ï¼›  </li>
<li>æœ€åè®¾ç½®ç”¨äºâ€œæ ¼å¼åŒ–â€å›¾ç‰‡çš„transformå‡½æ•°ã€‚  </li>
</ol>
</li>
<li><p>__getitem__(self, idx)<br>  __getitem__å‡½æ•°ï¼Œåœ¨testé˜¶æ®µåªè¿”å›å›¾ç‰‡ï¼Œåœ¨trainé˜¶æ®µè¿”å›å›¾ç‰‡ä»¥åŠå¯¹åº”GTã€‚ç›®å‰æˆ‘åªå®ç°äº†trainé˜¶æ®µçš„éƒ¨åˆ†ï¼š  </p>
<ol>
<li>ä»__init__ä¸­å·²ç»åˆå§‹åŒ–çš„æ‰€æœ‰å›¾ç‰‡ä¿¡æ¯ä¸­è·å¾—æŒ‡å®šidxçš„å›¾ç‰‡åï¼Œå¹¶è¯»å–è¯¥å›¾ç‰‡ï¼Œç„¶åä½¿ç”¨__init__ä¸­çš„â€œæ ¼å¼åŒ–â€æ‰‹æ®µå˜æ¢å›¾ç‰‡ï¼›  </li>
<li>ä»__init__ä¸­å·²ç»è§£æå¥½çš„bboxä¿¡æ¯å’Œlabelä¿¡æ¯ä¸­ï¼Œå–å¾—æŒ‡å®šidxå¯¹åº”çš„æ•°æ®ã€‚  </li>
<li>è¿”å›å›¾ç‰‡+GTæ•°æ®ï¼ˆannotationä¸­è§£æå‡ºçš„å†…å®¹ï¼‰ã€‚è¿™é‡Œä½¿ç”¨çš„æ•°æ®é›†ä¸­ä¸å«æœ‰è´Ÿæ ·æœ¬ï¼ˆæ²¡æœ‰ç›®æ ‡çš„æ ·æœ¬å›¾ç‰‡ï¼‰ã€‚  </li>
</ol>
</li>
<li><p>__len__(self)<br>  __len__å‡½æ•°è¿”å›æ•°æ®é›†çš„å¤§å°ï¼ˆå›¾ç‰‡æ•°é‡ï¼‰ï¼š<br>  è¿”å›__init__ä¸­å­˜å‚¨æ‰€æœ‰å›¾ç‰‡ä¿¡æ¯çš„listçš„é•¿åº¦å³å¯ã€‚  </p>
</li>
<li><p>show(img, bboxes):<br>  ä¸ºäº†å¯è§†åŒ–æ•°æ®åŠ è½½çš„æ˜¯å¦æˆåŠŸï¼Œæˆ‘ç¼–å†™ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼š  </p>
<pre><code>def show(img, bboxes):  
    &quot;&quot;&quot;  
    imgä¸ºtensoræ ¼å¼ï¼Œbboxä¸ºlist  
    &quot;&quot;&quot;  
    img = np.array(img)  
    img = np.transpose(img,(1,2,0))  
    plt.imshow(img)  
    #ç”»çŸ©å½¢æ¡†  
    for bbox in bboxes:  
        xmin = bbox[0]  
        ymin = bbox[1]  
        xmax = bbox[2]  
        ymax = bbox[3]  
        top = ([xmin, xmax], [ymin, ymin])  
        right = ([xmax, xmax], [ymin, ymax])  
        botton = ([xmax, xmin], [ymax, ymax])  
        left = ([xmin, xmin], [ymax, ymin])  
        lines = [top, right, botton, left]  
        for line in lines:  
            plt.plot(*line, color = &#39;r&#39;)  
            plt.scatter(*line, color = &#39;b&#39;)  
    #è°ƒæ•´åŸç‚¹åˆ°å·¦ä¸Šè§’  
    ax = plt.gca()  
    ax.xaxis.set_ticks_position(&#39;top&#39;)  
    plt.show()  
</code></pre>
</li>
</ul>
<h2 id="train-pyè§£æ"><a href="#train-pyè§£æ" class="headerlink" title="train.pyè§£æ"></a>train.pyè§£æ</h2><p>train.pyå³æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ï¼ŒåŒ…å«é‡‡æ ·ç­–ç•¥ã€‚å¸¸è§„è®­ç»ƒæµç¨‹ï¼šåŠ è½½æ•°æ®é›† -&gt; è®¾ç½®train_loader -&gt; ç½‘ç»œåˆå§‹åŒ– -&gt; è®¾ç½®æŸå¤±å‡½æ•° -&gt; è®¾ç½®ä¼˜åŒ–ç­–ç•¥ -&gt; è°ƒæ•´ç½‘ç»œä¸ºè®­ç»ƒæ¨¡å¼ -&gt; è®­ç»ƒå¾ªç¯ã€‚ä»¥ä¸‹åˆ—ä¸¾é‡ç‚¹è¿›è¡Œåˆ†æï¼š  </p>
<ul>
<li><p>train_loaderï¼šé¦–å…ˆæ ¹æ®batchsizeçš„æ•°å€¼å†³å®šè°ƒç”¨DenseBoxDatasetçš„<code>__getitem__</code>å‡½æ•°çš„æ¬¡æ•°ï¼›ç„¶åé€šè¿‡<code>collate_fn</code>å‡½æ•°å¯¹è¯»å–åˆ°çš„batchè¿›ä¸€æ­¥åŠ å·¥ï¼šå°†è¯»å–åˆ°çš„ä¸€ä¸ªbatchä¸­çš„å¤šç»„æ•°æ®æ•´åˆï¼Œå³å¢åŠ ä¸€ä¸ªbatchç»´åº¦ï¼›æœ€åå°†batchsizeä¸ªçš„batchåˆå¹¶ã€‚  </p>
<pre><code>def collate_fn_customer(batch):  
images = []  
bboxes = []  
for i, data in enumerate(batch):  
    # data[0]ä¸ºimgç»´åº¦  
    images.append(data[0])  
    # data[1]ä¸ºbboxç»´åº¦  
    bboxes.append(data[1])  
#å¯¹imagesè¿›è¡Œç±»å‹è½¬æ¢:list-&gt;torch.tensor  
#æ³¨æ„ä¸€å¼ å›¾ç‰‡ä¸­å¯èƒ½æœ‰å¤šä¸ªbboxï¼Œbboxç»´åº¦ä¸åŒä½¿ç”¨`stack`å‡½æ•°ä¼šæŠ¥é”™,å› æ­¤ç›´æ¥è¿”å›listå½¢å¼çš„bboxes  
images = torch.stack(images)  
batch = (images, bboxes)  
return batch  
</code></pre>
</li>
<li><p>å®šä¹‰ç½‘ç»œã€æŸå¤±å‡½æ•°ã€ä¼˜åŒ–ç­–ç•¥ï¼Œç½‘ç»œå’Œæ•°æ®éœ€è¦åŠ è½½åˆ°GPUä¸Šï¼Œä¹‹åè®¾ç½®ç½‘ç»œä¸ºè®­ç»ƒæ¨¡å¼ï¼š  </p>
<pre><code>os.environ[&#39;CUDA_DEVICE_ORDER&#39;] = &#39;PCI_BUS_ID&#39;  
os.environ[&#39;CUDA_VISIBLE_DEVICES&#39;] = &#39;1&#39;  
device = torch.device(&#39;cuda: 0&#39; if torch.cuda.is_available() else &#39;cpu&#39;)  

net = DenseBox(vgg19=vgg19_pretrain).to(device)  
loss_func = nn.MSELoss(reduce=False).to(device)  
optimizer = torch.optim.SGD(net.parameters(),  
                        lr=base_lr,  
                        momentum=9e-1,  
                        weight_decay=5e-8)  # 5e-4 or 5e-8  

net.train()  
</code></pre>
</li>
<li><p>ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ï¼šä»dataloaderä¸­ä»¥batchsizeä¸ºå•ä½è¯»å–æ•°æ®ï¼Œbatchä¸­åˆ†æˆä¸¤éƒ¨åˆ†ï¼šimgå’ŒGTï¼Œimgä½œä¸ºç½‘ç»œè¾“å…¥ï¼ŒGTè½¬æ¢æˆæŒ‡å®šå½¢å¼åï¼Œå‚ä¸åç»­æŸå¤±çš„è®¡ç®—ï¼š  </p>
<ol>
<li><p>è¯»å–batch[0]å­˜å‚¨çš„imgsæ•°æ®å¹¶åŠ è½½åˆ°GPUä¸Š  </p>
</li>
<li><p>è¯»å–batch[1]å­˜å‚¨çš„bboxesæ•°æ®ï¼šå°†bboxesæ•°æ®è½¬æ¢åˆ°ä¸è¾“å‡ºç‰¹å¾å›¾å°ºå¯¸å¯¹åº”çš„score_mapã€dist_mapä¸Šï¼Œç”¨äºæŸå¤±è®¡ç®—ï¼›å°†bboxesæ•°æ®è½¬æ¢åˆ°mask_mapä¸Šï¼Œç”¨äºåº”ç”¨é‡‡æ ·ç­–ç•¥ã€‚ç„¶åå°†å®ƒä»¬åŠ è½½åˆ°GPUä¸Šã€‚  </p>
</li>
<li><p>æ¸…ç©ºæ¢¯åº¦-&gt;å‰å‘ä¼ æ’­-&gt;è®¡ç®—åˆ†ç±»å’Œå®šä½æŸå¤±  </p>
</li>
<li><p>é‡‡æ ·ç­–ç•¥ï¼ˆä»¥batch_sizeä¸ºå•ä½è¿›è¡Œé‡‡æ ·ï¼Œè€Œä¸æ˜¯ä¸€å¼ å›¾ä¸ºå•ä½ï¼‰ï¼š  </p>
<pre><code># ç»Ÿè®¡æ­£æ ·æœ¬æ•°é‡  
pos_indices = torch.nonzero(cls_maps_gt)  
positive_num = pos_indices.size(0)  
# è´Ÿæ ·æœ¬ä¸æ­£æ ·æœ¬ç›¸ç­‰:img.size(0)å³batch_size,è‹¥è¿™é‡Œä½¿ç”¨batch_sizeä¼šåœ¨æœ€åä¸è¶³ä¸€ä¸ªå®Œæ•´batchæ—¶æŠ¥é”™  
neg_num = int(float(positive_num) / float(img.size(0)) + 0.5)  
# è·å¾—è´Ÿæ ·æœ¬çš„maskæ©ç ï¼Œç”¨äºé‡‡è´Ÿæ ·æœ¬  
ones_mask = torch.ones([img.size(0), 1, 60, 60],  
                        dtype=torch.float32).to(device)  
neg_mask = ones_mask - cls_maps_gt  
neg_cls_loss = cls_loss * neg_mask  
# ä¸€åŠä»å›°éš¾è´Ÿæ ·æœ¬è·å¾—,ä¸€åŠéšæœºé‡‡æ ·  
half_neg_num = int(neg_num * 0.5 + 0.5)  
neg_cls_loss = neg_cls_loss.view(img.size(0), -1)  
hard_negs, hard_neg_indices = torch.topk(input=neg_cls_loss,  
                                            k=half_neg_num,  
                                            dim=1)  
# éšæœºé‡‡æ ·å¯æ”¹è¿›ä¸ºä»è´Ÿæ ·æœ¬ä¸­é‡‡æ ·,ç›®å‰æ˜¯ä»å…¨ä½“æ ·æœ¬ä¸­éšæœºé‡‡æ ·  
rand_neg_indices = torch.zeros([img.size(0), half_neg_num], dtype=torch.long).to(device)  
for i in range(img.size(0)):  
    indices = np.random.choice(3600, #60*60  
                                half_neg_num,  
                                replace=False)  
    indices = torch.Tensor(indices)  
    rand_neg_indices[i] = indices  
#æ±‡æ€»è´Ÿæ ·æœ¬indices  
neg_indices = torch.cat((hard_neg_indices,  
                            rand_neg_indices),  
                        dim=1)  
neg_indices = neg_indices.cpu()  
pos_indices = pos_indices.cpu()  
</code></pre>
<p> è¿™æ ·æ­£è´Ÿæ ·æœ¬ç‚¹å°±ç¡®å®šäº†ã€‚  </p>
</li>
<li><p>å°†ä¸Šè¿°ä¸€ç»´ç©ºé—´çš„æ ·æœ¬idxè½¬æ¢åˆ°(batchsize, 1, w, h)åæ ‡ç©ºé—´ä¸­ï¼Œæ›´æ–°mask_mapï¼›ç„¶åé€šè¿‡grayzoneå»é™¤æ‰bboxè¾¹ç¼˜çš„ä¸€éƒ¨åˆ†æ­£æ ·æœ¬ï¼Œæ›´æ–°mask_map;æœ€ç»ˆç¡®å®šå…¨éƒ¨é‡‡æ ·ç‚¹ã€‚  </p>
</li>
<li><p>æœ€åå°†mask_mapä¸æŸå¤±mapç›¸ç‚¹ä¹˜ï¼Œå³å¯å¾—åˆ°æœ€ç»ˆçš„æŸå¤±ï¼š  </p>
<pre><code>mask_cls_loss = mask_maps * cls_loss    #åˆ†ç±»æŸå¤±  
mask_bbox_loc_loss = mask_maps * cls_maps_gt * bbox_loc_loss    #å®šä½æŸå¤±  
full_loss = lambda_cls * (torch.sum(mask_cls_loss)  
            + lambda_loc * torch.sum(mask_bbox_loc_loss))  
</code></pre>
</li>
<li><p>åå‘ä¼ æ’­å’Œæ›´æ–°å‚æ•°ï¼š  </p>
<pre><code>full_loss.backward()  
optimizer.step()  
</code></pre>
</li>
<li><p>logä¿¡æ¯çš„è¾“å‡ºä¸ä¿å­˜ã€logä¿¡æ¯çš„è¾“å‡ºä¸ä¿å­˜ã€checkpointçš„ä¿å­˜ï¼ˆä¸åŒé¢‘ç‡ï¼‰ã€‚å¦å¤–å­¦ä¹ ç‡å¯ä»¥éšç€epochçš„å¢åŠ ä½œç›¸åº”è°ƒæ•´ï¼š  </p>
<pre><code>def adjust_LR(optimizer, epoch):  
    lr = 1e-9  
    if epoch &lt; 5:  
        lr = 1e-9  
    elif epoch &gt;= 5 and epoch &lt; 10:  
        lr = 2e-9  
    elif epoch &gt;= 10 and epoch &lt; 15:  
        lr = 4e-9  
    else:  
        lr = 1e-9  
    for param_group in optimizer.param_groups:  
        param_group[&#39;lr&#39;] = lr    #æ›´æ–°lr  

    return lr  
</code></pre>
</li>
</ol>
</li>
</ul>
<h2 id="test-pyè§£æ"><a href="#test-pyè§£æ" class="headerlink" title="test.pyè§£æ"></a>test.pyè§£æ</h2><p>test.pyå³æ¨¡å‹æµ‹è¯•è¿‡ç¨‹ï¼š<br>åˆå§‹åŒ–ç½‘ç»œå¹¶åŠ è½½åˆ°GPU-&gt;ç½‘ç»œåˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼-&gt;è¯»å–æµ‹è¯•å›¾ç‰‡å¹¶åšç›¸åº”å˜æ¢-&gt;æ•°æ®è¾“å…¥ç½‘ç»œå¾—åˆ°è¾“å‡º-&gt;è§£æè¾“å‡ºå¹¶å¯è§†åŒ–ï¼ˆç›®å‰æœªå®ç°ç»Ÿè®¡è¯„ä¼°çš„åŠŸèƒ½ï¼‰ã€‚ä»¥ä¸‹åˆ—ä¸¾é‡ç‚¹å¹¶åˆ†æï¼š  </p>
<ul>
<li>åˆå§‹åŒ–ç½‘ç»œï¼šé¦–å…ˆåŠ è½½vgg19é¢„è®­ç»ƒæ¨¡å‹ï¼Œç„¶åä½¿ç”¨vgg19åˆå§‹åŒ–DenseBoxç½‘ç»œï¼Œæœ€åå°†ä¿å­˜çš„æ£€æŸ¥ç‚¹åŠ è½½åˆ°DenseBoxç½‘ç»œã€‚  <pre><code>vgg19_pretrain = torchvision.models.vgg19()  
vgg19_pretrain.load_state_dict(torch.load(&#39;vgg19.pth&#39;))  
net = DenseBox(vgg19=vgg19_pretrain).to(device)  
net.load_state_dict(torch.load(resume))  
print(&#39;=&gt; ç½‘ç»œä» &#123;&#125; åŠ è½½&#39;.format(resume))  
</code></pre>
</li>
<li>ä½¿ç”¨visdomè§‚å¯Ÿé¢„æµ‹ç»“æœç½®ä¿¡åº¦çƒ­å›¾ï¼š  <pre><code>import visdom  
vis = visdom.Visdom()  
vis.heatmap(score_out[0,0])  
</code></pre>
</li>
<li>è§£æè¾“å‡ºåä½¿ç”¨éæå¤§æŠ‘åˆ¶ç®—æ³•ï¼Œæœ€åè®­ç»ƒé˜¶æ®µç¼–å†™çš„<code>show</code>å‡½æ•°å¯è§†åŒ–ç»“æœï¼š  <pre><code>#ä¿ç•™ç½®ä¿¡åº¦å‰Kçš„ç»“æœï¼Œå¹¶ä¸”è§£ææˆbboxå½¢å¼è¿”å›  
dets = parse_out_MN(score_map=score_out.cpu(),  
                            loc_map=loc_out.cpu(),  
                            M=H,  
                            N=W,  
                            K=10)  
# éæå¤§æŠ‘åˆ¶  
keep = NMS(dets=dets, nms_thresh=0.4)  
dets = dets[keep]  
# å¯è§†åŒ–ç»“æœ(GT+DT)  
show(img_tensor, [[60,101,181,143]])  
show(img_tensor, dets)  
</code></pre>
</li>
</ul>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™æ¬¡å¤ç°çš„æœ¬è´¨æ˜¯ä»å¤´åˆ°å°¾ç»†è‡´åœ°è¯»äº†ä¸€éä»£ç ã€‚æ”¶è·æœ€å¤§çš„åœ°æ–¹æ˜¯å¯¹æ•°æ®é‡‡æ ·è¿™ä¸ªæ–¹é¢ï¼Œæœ‰äº†ç»†è‡´çš„äº†è§£ã€‚<br>ç½‘ç»œå’Œä»£ç ç›®å‰å¯ä»¥æ”¹è¿›çš„åœ°æ–¹å¾ˆå¤šï¼š  </p>
<ol>
<li>ä¸æ”¯æŒå¤šå°ºåº¦ï¼Œå¯ä»¥ç»“åˆFPNåšæ”¹è¿›  </li>
<li>æ•°æ®åŠ è½½è€—æ—¶é•¿ï¼Œå¯ä»¥è€ƒè™‘å¤šä¸ªbatch_sizeçš„æ•°æ®æ‰¹é‡åŠ è½½åˆ°å†…å­˜  </li>
<li>æµ‹è¯•æ—¶çš„dataloaderæœªå®Œæˆ  </li>
<li>evaluateåŠŸèƒ½æœªå®ç°  </li>
<li>ç»†èŠ‚å¤„å¯ä»¥æ”¹è¿›<br>DenseBoxä»£ç å¤ç°å‘Šä¸€æ®µè½ï¼Œä¹‹åæœ‰æ—¶é—´å¯èƒ½ä¼šä¼˜åŒ–ä»£ç ã€‚æ¥ä¸‹æ¥æ›´å¤šç€é‡åœ¨mmdetection toolboxä¸Šï¼Œå®ƒçš„æ•´ä¸ªæ¡†æ¶ç»“æ„æ›´åŠ æˆç†Ÿï¼Œå¹¶ä¸”ä¹Ÿæ›´åŠ é«˜æ•ˆï¼Œå€¼å¾—æ·±å…¥ç ”ç©¶ã€‚  </li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/29/Learning-DenseBox/" data-id="ckktumz8l0000zttmgl8jc624" data-title="DenseBoxä»£ç è§£æ" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/05/Writing-Blog-in-GitPage/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          Blog in GitPage
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/02/05/Writing-Blog-in-GitPage/">Blog in GitPage</a>
          </li>
        
          <li>
            <a href="/2019/08/29/Learning-DenseBox/">DenseBoxä»£ç è§£æ</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 Kyno Yang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>